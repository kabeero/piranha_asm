  0 000h |                         | ;-------------------------------------------------------------------------------
  0 000h |                         | ; median3.asm
  0 000h |                         | ;
  0 000h |                         | ; Applies a 3x3 median filter over the entire image.  This removes fine lines
  0 000h |                         | ; and reduces speckle.  Currently edge-cases are not handled any different than
  0 000h |                         | ; the rest of the image.
  0 000h |                         | ;-------------------------------------------------------------------------------
  0 000h |                         | 
  0 000h |                         | ; Define new instruction labels to make the code intuitive to read.
  0 000h |                         | 
  0 000h |                         | #define PXL_ROW_MASK        00111000b   ; The row bits for pixels
  0 000h |                         | #define PXL_COL_MASK        00000111b   ; The column bits for pixels
  0 000h |                         | 
  0 000h |                         | #define PXL_EDGE_N          00000000b   ; Matches pixels on N edge of NP
  0 000h |                         | #define PXL_EDGE_S          00111000b   ; Matches pixels on S edge of NP
  0 000h |                         | #define PXL_EDGE_W          00000000b   ; Matches pixels on W edge of NP
  0 000h |                         | #define PXL_EDGE_E          00000111b   ; Matches pixels on E edge of NP
  0 000h |                         |  
  0 000h |                         | #define START_OF_X          00000000b   ; Starting address of X RAM.
  0 000h |                         | #define START_OF_Y          01000000b   ; Starting address of Y RAM.
  0 000h |                         | #define START_OF_Z          10000000b   ; Starting address of X RAM.
  0 000h |                         | #define START_OF_V          11000000b   ; Starting address of V RAM.
  0 000h |                         |  
  0 000h |                         | #define TRUE                 1          ; True pattern
  0 000h |                         | #define FALSE                0          ; False pattern
  0 000h |                         | #define NULL                -1          ; Null pattern
  0 000h |                         | 
  0 000h |                         | #define NUM_PIXELS          64          ; The number of pixels in the NP.
  0 000h |                         | #define MASK_AF 01000000b               ; Mask for ADC active flag
  0 000h |                         | #define BZ      BEQ                     ; Alias branch if zero to branch if equal
  0 000h |                         | #define BNZ     BNE                     ; Alias branch if not zero to branch if not equal
  0 000h |                         | 
  0 000h |                         | ; Algorithm variables.
  0 000h |                         | 
  0 000h |                         | #define index               r0          ; The center pixel being evaluated
  0 000h |                         | #define pxl_row             r2          ; The center pixel being evaluated
  0 000h |                         | #define pxl_col             r3          ; The center pixel being evaluated
  0 000h |                         | 
  0 000h |                         | ; Algorithm constants.
  0 000h |                         | 
  0 000h |                         | ; Macros
  0 000h |                         | 
  0 000h |                         | ; Sorts two entries in the kernel
  0 000h |                         | ;#macro sort2 (a, b)
  0 000h |                         | ;    LDR r0, z[$a]
  0 000h |                         | ;    LDR r1, z[$b]
  0 000h |                         | ;    CMP r0, r1
  0 000h |                         | ;    ZLS
  0 000h |                         | ;        STR r1, z[$a]
  0 000h |                         | ;        STR r0, z[$b]
  0 000h |                         | ;    WAK
  0 000h |                         | ;#endmacro
  0 000h |                         |        
  0 000h |                         | ;-------------------------------------------------------------------------------
  0 000h |                         | 
  0 000h |                         |  
  0 000h |                         | START:
  0 000h |                         |  
  0 000h |                         | CLEAN_SLATE_INIT:
  0 000h |                         |  
  0 000h | 4100h 0100000100000000b |     LDR     r0, 0           ; Overwrite x ram with constant (note this is in gray code)
  1 001h | 4500h 0100010100000000b |     LDR     r2, 00h      
  2 002h | 42D0h 0100001011010000b |     LDR     r1, r0          ; Calculate the final address
  3 003h | 0340h 0000001101000000b |     ADD     r1, 64      
  4 004h |                         | 
  4 004h |                         | CLEAN_SLATE_LOOP:
  4 004h |                         | 
  4 004h | 4CF0h 0100110011110000b |     STR     r2, [r0]
  5 005h | 0101h 0000000100000001b |     ADD     r0, 1
  6 006h | 38D1h 0011100011010001b |     CMP     r0, r1
  7 007h | C041h 1100000001000001b |     BNE     CLEAN_SLATE_LOOP
  8 008h |                         | 
  8 008h |                         | ACQUIRE_RESET_IMAGE:
  8 008h |                         | 
  8 008h | 8220h 1000001000100000b |     IMG                     ; Acquire a new image from the ADCs with t_int = 0
  9 009h |                         | 
  9 009h |                         | WAIT_FOR_RESET_ADC:
  9 009h |                         | 
  9 009h | 40F4h 0100000011110100b |     LDR     r0, SR              ; Load the status register
 10 00Ah | 2140h 0010000101000000b |     AND     r0, MASK_AF         ; Check if the ADC is active
 11 00Bh | C091h 1100000010010001b |     BNZ     WAIT_FOR_RESET_ADC  ; Loop while the ADC is converting
 12 00Ch |                         | 
 12 00Ch |                         | MOVE_TO_Y_INIT:
 12 00Ch |                         | 
 12 00Ch | 4300h 0100001100000000b |     LDR     r1, START_OF_X
 13 00Dh | 4540h 0100010101000000b |     LDR     r2, START_OF_Y
 14 00Eh |                         | 
 14 00Eh |                         | MOVE_TO_Y:
 14 00Eh |                         | 
 14 00Eh | 40F1h 0100000011110001b |     LDR     r0, [r1]
 15 00Fh | 8820h 1000100000100000b |     GTB     r0
 16 010h | 48F2h 0100100011110010b |     STR     r0, [r2]
 17 011h | 0301h 0000001100000001b |     ADD     r1, 1
 18 012h | 0501h 0000010100000001b |     ADD     r2, 1
 19 013h | 3B40h 0011101101000000b |     CMP     r1, 64
 20 014h | C0E1h 1100000011100001b |     BNE     MOVE_TO_Y
 21 015h |                         |  
 21 015h |                         | ACQUIRE_IMAGE:
 21 015h |                         | 
 21 015h | 8220h 1000001000100000b |     IMG                     ; Acquire a new image from the ADCs
 22 016h |                         | 
 22 016h |                         | WAIT_FOR_ADC:
 22 016h |                         | 
 22 016h |                         |     ; At this point, the FSM for the ADC is running.  Read the status register
 22 016h |                         |     ; to check if the conversion is finished. (Note: very inefficient)
 22 016h |                         | 
 22 016h | 40F4h 0100000011110100b |     LDR     r0, SR          ; Load the status register
 23 017h | 2140h 0010000101000000b |     AND     r0, MASK_AF     ; Check if the ADC is active
 24 018h | C161h 1100000101100001b |     BNZ     WAIT_FOR_ADC    ; Loop while the ADC is converting
 25 019h |                         |  
 25 019h |                         | DIFFERENCE_INIT:
 25 019h |                         | 
 25 019h | 4300h 0100001100000000b |     LDR     r1, START_OF_X
 26 01Ah | 4540h 0100010101000000b |     LDR     r2, START_OF_Y
 27 01Bh |                         | 
 27 01Bh |                         | DIFFERENCE:
 27 01Bh |                         | 
 27 01Bh | 40F1h 0100000011110001b |     LDR     r0, [r1]
 28 01Ch | 8820h 1000100000100000b |     GTB     r0
 29 01Dh | 10F2h 0001000011110010b |     SUB     r0, [r2]
 30 01Eh | 48F1h 0100100011110001b |     STR     r0, [r1]
 31 01Fh | 0301h 0000001100000001b |     ADD     r1, 1
 32 020h | 0501h 0000010100000001b |     ADD     r2, 1
 33 021h | 3B40h 0011101101000000b |     CMP     r1, 64
 34 022h | C1B1h 1100000110110001b |     BNE     DIFFERENCE
 35 023h |                         | 
 35 023h |                         | ;-------------------------------------------------------------------------------
 35 023h |                         | 
 35 023h |                         | MEDIAN3:
 35 023h |                         | 
 35 023h |                         | M3_INIT:
 35 023h |                         | 
 35 023h | 4100h 0100000100000000b |     LDR     index, 0                   ; Start with the upper-left pixel
 36 024h |                         | 
 36 024h |                         | M3_LOOP:
 36 024h |                         | 
 36 024h |                         |     ; Save variables for the row and column number of the current pixel index.
 36 024h |                         | 
 36 024h | 44D0h 0100010011010000b |     LDR     pxl_row, index
 37 025h | 2538h 0010010100111000b |     AND     pxl_row, PXL_ROW_MASK
 38 026h | 46D0h 0100011011010000b |     LDR     pxl_col, index
 39 027h | 2707h 0010011100000111b |     AND     pxl_col, PXL_COL_MASK
 40 028h |                         | 
 40 028h |                         | LOAD_KERNEL:
 40 028h |                         | 
 40 028h |                         |     ; Copy the kernel values into a separate memory location to prevent the
 40 028h |                         |     ; image from being corrupted and to give prepare them for the median 
 40 028h |                         |     ; search algorithm, which expects them to be in a specific location.
 40 028h |                         | 
 40 028h |                         | ;-------------------------------------------------------------------------------
 40 028h |                         | 
 40 028h |                         | LOAD_KERNEL_CENTER:
 40 028h |                         | 
 40 028h |                         |     ; First copy the center pixel from x[index], to z[4].  Unlike the edge
 40 028h |                         |     ; pixels, this one is always located in the local NP.
 40 028h |                         | 
 40 028h | 42F0h 0100001011110000b |     LDR     r1, [index]
 41 029h | 4A84h 0100101010000100b |     STR     r1, z[4]
 42 02Ah |                         | 
 42 02Ah |                         | ;-------------------------------------------------------------------------------
 42 02Ah |                         | 
 42 02Ah |                         | LOAD_KERNEL_NW:
 42 02Ah |                         | 
 42 02Ah |                         | LOAD_KERNEL_NW_CHECK_IF_NW_CORNER:
 42 02Ah |                         | 
 42 02Ah | 3900h 0011100100000000b |     CMP     index, {PXL_EDGE_N + PXL_EDGE_W}
 43 02Bh | C311h 1100001100010001b |     BNE     LOAD_KERNEL_NW_CHECK_IF_N_EDGE
 44 02Ch | 423Fh 0100001000111111b |     LDR     r1, x[63]       ; This is the SE pixel to be sent to the SE NP
 45 02Dh | 42E1h 0100001011100001b |     LDR     r1, N           ; Move from NW NP to W NP
 46 02Eh | 42E4h 0100001011100100b |     LDR     r1, W           ; Move from W NP to local NP
 47 02Fh | 4A80h 0100101010000000b |     STR     r1, z[0]
 48 030h | C46Fh 1100010001101111b |     B       LOAD_KERNEL_N
 49 031h |                         |                                           
 49 031h |                         | LOAD_KERNEL_NW_CHECK_IF_N_EDGE:
 49 031h |                         | 
 49 031h | 3D00h 0011110100000000b |     CMP     pxl_row, PXL_EDGE_N
 50 032h | C391h 1100001110010001b |     BNE     LOAD_KERNEL_NW_CHECK_IF_W_EDGE
 51 033h | 0137h 0000000100110111b |     ADD     index, 55       ; Get the NW pixel for the NP to the S.
 52 034h | 42F0h 0100001011110000b |     LDR     r1, [index]
 53 035h | 42E1h 0100001011100001b |     LDR     r1, N
 54 036h | 4A80h 0100101010000000b |     STR     r1, z[0]
 55 037h | 1137h 0001000100110111b |     SUB     index, 55       ; Return to center
 56 038h | C46Fh 1100010001101111b |     B       LOAD_KERNEL_N
 57 039h |                         |                                           
 57 039h |                         | LOAD_KERNEL_NW_CHECK_IF_W_EDGE:
 57 039h |                         | 
 57 039h | 3F00h 0011111100000000b |     CMP     pxl_col, PXL_EDGE_W
 58 03Ah | C411h 1100010000010001b |     BNE     LOAD_KERNEL_NW_IS_IN_INTERIOR
 59 03Bh | 1101h 0001000100000001b |     SUB     index, 1        ; Get the NW pixel for the NP to the E.
 60 03Ch | 42F0h 0100001011110000b |     LDR     r1, [index]
 61 03Dh | 42E4h 0100001011100100b |     LDR     r1, W
 62 03Eh | 4A80h 0100101010000000b |     STR     r1, z[0]
 63 03Fh | 0101h 0000000100000001b |     ADD     index, 1        ; Return to center
 64 040h | C46Fh 1100010001101111b |     B       LOAD_KERNEL_N
 65 041h |                         |      
 65 041h |                         | LOAD_KERNEL_NW_IS_IN_INTERIOR:
 65 041h |                         | 
 65 041h | 1109h 0001000100001001b |     SUB     index, 9        ; This moves to the pixel NW of index
 66 042h | 42F0h 0100001011110000b |     LDR     r1, [index]
 67 043h | 4A80h 0100101010000000b |     STR     r1, z[0]
 68 044h | 0109h 0000000100001001b |     ADD     index, 9        ; return to center
 69 045h | C46Fh 1100010001101111b |     B       LOAD_KERNEL_N
 70 046h |                         | 
 70 046h |                         | ;-------------------------------------------------------------------------------
 70 046h |                         | 
 70 046h |                         | LOAD_KERNEL_N:
 70 046h |                         | 
 70 046h |                         | LOAD_KERNEL_N_CHECK_IF_N_EDGE:
 70 046h |                         |                               
 70 046h | 3D00h 0011110100000000b |     CMP     pxl_row, PXL_EDGE_N
 71 047h | C4E1h 1100010011100001b |     BNE     LOAD_KERNEL_N_IS_IN_INTERIOR
 72 048h | 0138h 0000000100111000b |     ADD     index, 56       ; Get the N pixel for the NP to the S.
 73 049h | 42F0h 0100001011110000b |     LDR     r1, [index]
 74 04Ah | 42E1h 0100001011100001b |     LDR     r1, N
 75 04Bh | 4A81h 0100101010000001b |     STR     r1, z[1]
 76 04Ch | 1138h 0001000100111000b |     SUB     index, 56       ; Return to center
 77 04Dh | C53Fh 1100010100111111b |     B       LOAD_KERNEL_NE
 78 04Eh |                         |                           
 78 04Eh |                         | LOAD_KERNEL_N_IS_IN_INTERIOR:
 78 04Eh |                         | 
 78 04Eh | 1108h 0001000100001000b |     SUB     index, 8        ; This moves to the pixel N of index
 79 04Fh | 42F0h 0100001011110000b |     LDR     r1, [index]
 80 050h | 4A81h 0100101010000001b |     STR     r1, z[1]
 81 051h | 0108h 0000000100001000b |     ADD     index, 8        ; return to center
 82 052h | C53Fh 1100010100111111b |     B       LOAD_KERNEL_NE
 83 053h |                         |                               
 83 053h |                         | ;-------------------------------------------------------------------------------
 83 053h |                         | 
 83 053h |                         | LOAD_KERNEL_NE:
 83 053h |                         | 
 83 053h |                         | LOAD_KERNEL_NE_CHECK_IF_NE_CORNER:
 83 053h |                         | 
 83 053h | 3907h 0011100100000111b |     CMP     index, {PXL_EDGE_N + PXL_EDGE_E}
 84 054h | C5A1h 1100010110100001b |     BNE     LOAD_KERNEL_NE_CHECK_IF_N_EDGE
 85 055h | 4238h 0100001000111000b |     LDR     r1, x[56]       ; This is the SE pixel to be sent to the SE NP
 86 056h | 42E1h 0100001011100001b |     LDR     r1, N           ; Move from NE NP to E NP
 87 057h | 42E8h 0100001011101000b |     LDR     r1, E           ; Move from E NP to local NP
 88 058h | 4A82h 0100101010000010b |     STR     r1, z[2]
 89 059h | C6FFh 1100011011111111b |     B       LOAD_KERNEL_E
 90 05Ah |                         |                     
 90 05Ah |                         | LOAD_KERNEL_NE_CHECK_IF_N_EDGE:
 90 05Ah |                         | 
 90 05Ah | 3D00h 0011110100000000b |     CMP     pxl_row, PXL_EDGE_N
 91 05Bh | C621h 1100011000100001b |     BNE     LOAD_KERNEL_NE_CHECK_IF_E_EDGE
 92 05Ch | 0139h 0000000100111001b |     ADD     index, 57       ; Get the NE pixel for the NP to the S.
 93 05Dh | 42F0h 0100001011110000b |     LDR     r1, [index]
 94 05Eh | 42E1h 0100001011100001b |     LDR     r1, N
 95 05Fh | 4A82h 0100101010000010b |     STR     r1, z[2]
 96 060h | 1139h 0001000100111001b |     SUB     index, 57       ; Return to center
 97 061h | C6FFh 1100011011111111b |     B       LOAD_KERNEL_E
 98 062h |                         |                     
 98 062h |                         | LOAD_KERNEL_NE_CHECK_IF_E_EDGE:
 98 062h |                         | 
 98 062h | 3F07h 0011111100000111b |     CMP     pxl_col, PXL_EDGE_E
 99 063h | C6A1h 1100011010100001b |     BNE     LOAD_KERNEL_NE_IS_IN_INTERIOR
100 064h | 110Fh 0001000100001111b |     SUB     index, 15       ; Get the NE pixel for the NP to the W.
101 065h | 42F0h 0100001011110000b |     LDR     r1, [index]
102 066h | 42E8h 0100001011101000b |     LDR     r1, E
103 067h | 4A82h 0100101010000010b |     STR     r1, z[2]
104 068h | 010Fh 0000000100001111b |     ADD     index, 15       ; Return to center
105 069h | C6FFh 1100011011111111b |     B       LOAD_KERNEL_E
106 06Ah |                         |      
106 06Ah |                         | LOAD_KERNEL_NE_IS_IN_INTERIOR:
106 06Ah |                         | 
106 06Ah | 1107h 0001000100000111b |     SUB     index, 7        ; This moves to the pixel NE of index
107 06Bh | 42F0h 0100001011110000b |     LDR     r1, [index]
108 06Ch | 4A82h 0100101010000010b |     STR     r1, z[2]
109 06Dh | 0107h 0000000100000111b |     ADD     index, 7        ; return to center
110 06Eh | C6FFh 1100011011111111b |     B       LOAD_KERNEL_E
111 06Fh |                         |              
111 06Fh |                         | ;-------------------------------------------------------------------------------
111 06Fh |                         | 
111 06Fh |                         | LOAD_KERNEL_E:
111 06Fh |                         | 
111 06Fh |                         | LOAD_KERNEL_E_CHECK_IF_E_EDGE:
111 06Fh |                         |                               
111 06Fh | 3F07h 0011111100000111b |     CMP     pxl_col, PXL_EDGE_E
112 070h | C771h 1100011101110001b |     BNE     LOAD_KERNEL_E_IS_IN_INTERIOR
113 071h | 1107h 0001000100000111b |     SUB     index, 7        ; Get the E pixel for the NP to the W.
114 072h | 42F0h 0100001011110000b |     LDR     r1, [index]
115 073h | 42E8h 0100001011101000b |     LDR     r1, E
116 074h | 4A85h 0100101010000101b |     STR     r1, z[5]
117 075h | 0107h 0000000100000111b |     ADD     index, 7        ; Return to center
118 076h | C7CFh 1100011111001111b |     B       LOAD_KERNEL_SE
119 077h |                         |                           
119 077h |                         | LOAD_KERNEL_E_IS_IN_INTERIOR:
119 077h |                         | 
119 077h | 0101h 0000000100000001b |     ADD     index, 1        ; This moves to the pixel E of index
120 078h | 42F0h 0100001011110000b |     LDR     r1, [index]
121 079h | 4A85h 0100101010000101b |     STR     r1, z[5]
122 07Ah | 1101h 0001000100000001b |     SUB     index, 1        ; return to center
123 07Bh | C7CFh 1100011111001111b |     B       LOAD_KERNEL_SE
124 07Ch |                         |                          
124 07Ch |                         | ;-------------------------------------------------------------------------------
124 07Ch |                         | 
124 07Ch |                         | LOAD_KERNEL_SE:
124 07Ch |                         | 
124 07Ch |                         | LOAD_KERNEL_SE_CHECK_IF_SE_CORNER:
124 07Ch |                         | 
124 07Ch | 393Fh 0011100100111111b |     CMP     index, {PXL_EDGE_S + PXL_EDGE_E}
125 07Dh | C831h 1100100000110001b |     BNE     LOAD_KERNEL_SE_CHECK_IF_S_EDGE
126 07Eh | 4200h 0100001000000000b |     LDR     r1, x[0]        ; This is the SE pixel for the NW NP
127 07Fh | 42E2h 0100001011100010b |     LDR     r1, S           ; Move from SE NP to E NP
128 080h | 42E8h 0100001011101000b |     LDR     r1, E           ; Move from E NP to local NP
129 081h | 4A88h 0100101010001000b |     STR     r1, z[8]
130 082h | C98Fh 1100100110001111b |     B       LOAD_KERNEL_S
131 083h |                         | 
131 083h |                         | LOAD_KERNEL_SE_CHECK_IF_S_EDGE:
131 083h |                         | 
131 083h | 3D38h 0011110100111000b |     CMP     pxl_row, PXL_EDGE_S
132 084h | C8B1h 1100100010110001b |     BNE     LOAD_KERNEL_SE_CHECK_IF_E_EDGE
133 085h | 1137h 0001000100110111b |     SUB     index, 55       ; Get the SE pixel for the NP to the N.
134 086h | 42F0h 0100001011110000b |     LDR     r1, [index]
135 087h | 42E2h 0100001011100010b |     LDR     r1, S
136 088h | 4A88h 0100101010001000b |     STR     r1, z[8]
137 089h | 0137h 0000000100110111b |     ADD     index, 55       ; Return to center
138 08Ah | C98Fh 1100100110001111b |     B       LOAD_KERNEL_S
139 08Bh |                         |                  
139 08Bh |                         | LOAD_KERNEL_SE_CHECK_IF_E_EDGE:
139 08Bh |                         | 
139 08Bh | 3F07h 0011111100000111b |     CMP     pxl_col, PXL_EDGE_E
140 08Ch | C931h 1100100100110001b |     BNE     LOAD_KERNEL_SE_IS_IN_INTERIOR
141 08Dh | 0101h 0000000100000001b |     ADD     index, 1        ; Get the SE pixel for the NP to the W.
142 08Eh | 42F0h 0100001011110000b |     LDR     r1, [index]
143 08Fh | 42E8h 0100001011101000b |     LDR     r1, E
144 090h | 4A88h 0100101010001000b |     STR     r1, z[8]
145 091h | 1101h 0001000100000001b |     SUB     index, 1        ; Return to center
146 092h | C98Fh 1100100110001111b |     B       LOAD_KERNEL_S
147 093h |                         |                  
147 093h |                         | LOAD_KERNEL_SE_IS_IN_INTERIOR:
147 093h |                         | 
147 093h | 0109h 0000000100001001b |     ADD     index, 9        ; This moves to the pixel SE of index
148 094h | 42F0h 0100001011110000b |     LDR     r1, [index]
149 095h | 4A88h 0100101010001000b |     STR     r1, z[8]
150 096h | 1109h 0001000100001001b |     SUB     index, 9        ; return to center
151 097h | C98Fh 1100100110001111b |     B       LOAD_KERNEL_S
152 098h |                         |      
152 098h |                         | ;-------------------------------------------------------------------------------
152 098h |                         | 
152 098h |                         | LOAD_KERNEL_S:
152 098h |                         | 
152 098h |                         | LOAD_KERNEL_S_CHECK_IF_S_EDGE:
152 098h |                         |                               
152 098h | 3D38h 0011110100111000b |     CMP     pxl_row, PXL_EDGE_S
153 099h | CA01h 1100101000000001b |     BNE     LOAD_KERNEL_S_IS_IN_INTERIOR
154 09Ah | 1138h 0001000100111000b |     SUB     index, 56       ; Get the S pixel for the NP to the N.
155 09Bh | 42F0h 0100001011110000b |     LDR     r1, [index]
156 09Ch | 42E2h 0100001011100010b |     LDR     r1, S
157 09Dh | 4A87h 0100101010000111b |     STR     r1, z[7]
158 09Eh | 0138h 0000000100111000b |     ADD     index, 56       ; Return to center
159 09Fh | CA5Fh 1100101001011111b |     B       LOAD_KERNEL_SW
160 0A0h |                         |                           
160 0A0h |                         | LOAD_KERNEL_S_IS_IN_INTERIOR:
160 0A0h |                         | 
160 0A0h | 0108h 0000000100001000b |     ADD     index, 8        ; This moves to the pixel S of index
161 0A1h | 42F0h 0100001011110000b |     LDR     r1, [index]
162 0A2h | 4A87h 0100101010000111b |     STR     r1, z[7]
163 0A3h | 1108h 0001000100001000b |     SUB     index, 8        ; return to center
164 0A4h | CA5Fh 1100101001011111b |     B       LOAD_KERNEL_SW
165 0A5h |                         |                                
165 0A5h |                         | ;-------------------------------------------------------------------------------
165 0A5h |                         | 
165 0A5h |                         | LOAD_KERNEL_SW:
165 0A5h |                         | 
165 0A5h |                         | LOAD_KERNEL_SW_CHECK_IF_SW_CORNER:
165 0A5h |                         | 
165 0A5h | 3938h 0011100100111000b |     CMP     index, {PXL_EDGE_S + PXL_EDGE_W}
166 0A6h | CAC1h 1100101011000001b |     BNE     LOAD_KERNEL_SW_CHECK_IF_S_EDGE
167 0A7h | 4207h 0100001000000111b |     LDR     r1, x[7]        ; This is the SW pixel to be sent to the NE NP
168 0A8h | 42E2h 0100001011100010b |     LDR     r1, S           ; Move from SW NP to W NP
169 0A9h | 42E4h 0100001011100100b |     LDR     r1, W           ; Move from W NP to local NP
170 0AAh | 4A86h 0100101010000110b |     STR     r1, z[6]
171 0ABh | CC1Fh 1100110000011111b |     B       LOAD_KERNEL_W
172 0ACh |                         |                  
172 0ACh |                         | LOAD_KERNEL_SW_CHECK_IF_S_EDGE:
172 0ACh |                         | 
172 0ACh | 3D38h 0011110100111000b |     CMP     pxl_row, PXL_EDGE_S
173 0ADh | CB41h 1100101101000001b |     BNE     LOAD_KERNEL_SW_CHECK_IF_W_EDGE
174 0AEh | 1139h 0001000100111001b |     SUB     index, 57       ; Get the SW pixel for the NP to the N.
175 0AFh | 42F0h 0100001011110000b |     LDR     r1, [index]
176 0B0h | 42E2h 0100001011100010b |     LDR     r1, S
177 0B1h | 4A86h 0100101010000110b |     STR     r1, z[6]
178 0B2h | 0139h 0000000100111001b |     ADD     index, 57       ; Return to center
179 0B3h | CC1Fh 1100110000011111b |     B       LOAD_KERNEL_W
180 0B4h |                         |                  
180 0B4h |                         | LOAD_KERNEL_SW_CHECK_IF_W_EDGE:
180 0B4h |                         | 
180 0B4h | 3F00h 0011111100000000b |     CMP     pxl_col, PXL_EDGE_W
181 0B5h | CBC1h 1100101111000001b |     BNE     LOAD_KERNEL_SW_IS_IN_INTERIOR
182 0B6h | 010Fh 0000000100001111b |     ADD     index, 15       ; Get the SW pixel for the NP to the E.
183 0B7h | 42F0h 0100001011110000b |     LDR     r1, [index]
184 0B8h | 42E4h 0100001011100100b |     LDR     r1, W
185 0B9h | 4A86h 0100101010000110b |     STR     r1, z[6]
186 0BAh | 110Fh 0001000100001111b |     SUB     index, 15       ; Return to center
187 0BBh | CC1Fh 1100110000011111b |     B       LOAD_KERNEL_W
188 0BCh |                         |      
188 0BCh |                         | LOAD_KERNEL_SW_IS_IN_INTERIOR:
188 0BCh |                         | 
188 0BCh | 0107h 0000000100000111b |     ADD     index, 7        ; This moves to the pixel SW of index
189 0BDh | 42F0h 0100001011110000b |     LDR     r1, [index]
190 0BEh | 4A86h 0100101010000110b |     STR     r1, z[6]
191 0BFh | 1107h 0001000100000111b |     SUB     index, 7        ; return to center
192 0C0h | CC1Fh 1100110000011111b |     B       LOAD_KERNEL_W
193 0C1h |                         |      
193 0C1h |                         | ;-------------------------------------------------------------------------------
193 0C1h |                         | 
193 0C1h |                         | LOAD_KERNEL_W:
193 0C1h |                         | 
193 0C1h |                         | LOAD_KERNEL_W_CHECK_IF_W_EDGE:
193 0C1h |                         |                               
193 0C1h | 3F00h 0011111100000000b |     CMP     pxl_col, PXL_EDGE_W
194 0C2h | CC91h 1100110010010001b |     BNE     LOAD_KERNEL_W_IS_IN_INTERIOR
195 0C3h | 0107h 0000000100000111b |     ADD     index, 7        ; Get the W pixel for the NP to the E.
196 0C4h | 42F0h 0100001011110000b |     LDR     r1, [index]
197 0C5h | 42E4h 0100001011100100b |     LDR     r1, W
198 0C6h | 4A83h 0100101010000011b |     STR     r1, z[3]
199 0C7h | 1107h 0001000100000111b |     SUB     index, 7        ; Return to center
200 0C8h | CCEFh 1100110011101111b |     B       FIND_MEDIAN
201 0C9h |                         |                           
201 0C9h |                         | LOAD_KERNEL_W_IS_IN_INTERIOR:
201 0C9h |                         | 
201 0C9h | 1101h 0001000100000001b |     SUB     index, 1        ; This moves to the pixel W of index
202 0CAh | 42F0h 0100001011110000b |     LDR     r1, [index]
203 0CBh | 4A83h 0100101010000011b |     STR     r1, z[3]
204 0CCh | 0101h 0000000100000001b |     ADD     index, 1        ; return to center
205 0CDh | CCEFh 1100110011101111b |     B       FIND_MEDIAN
206 0CEh |                         | 
206 0CEh |                         | ;-------------------------------------------------------------------------------
206 0CEh |                         | 
206 0CEh |                         | FIND_MEDIAN:
206 0CEh |                         | 
206 0CEh | 46D0h 0100011011010000b |     LDR     r3, index           ; Find the index in the resulting filtered image
207 0CFh | 0740h 0000011101000000b |     ADD     r3, START_OF_Y
208 0D0h | EDA0h 1110110110100000b |     BL      Find_Kernel_Median  ; Compute the median value, return in r0
209 0D1h | 48F3h 0100100011110011b |     STR     r0, [r3]            ; Store the median in Y memory
210 0D2h | 1740h 0001011101000000b |     SUB     r3, START_OF_Y      ; Restore the index
211 0D3h | 40D3h 0100000011010011b |     LDR     index, r3
212 0D4h |                         | 
212 0D4h |                         | CHECK_LOOP_CONDITION:
212 0D4h |                         | 
212 0D4h | 0101h 0000000100000001b |     ADD     index, 1
213 0D5h | 3940h 0011100101000000b |     CMP     index, NUM_PIXELS
214 0D6h | C24Bh 1100001001001011b |     BLT     M3_LOOP
215 0D7h |                         |     
215 0D7h |                         | M3_LOOP_END:
215 0D7h |                         | 
215 0D7h | 4140h 0100000101000000b |     LDR     r0, START_OF_Y
216 0D8h | F680h 1111011010000000b |     BL      Output_Data_Block   ; Output the image
217 0D9h | C00Fh 1100000000001111b |     B       START               ; Infinite loop
218 0DAh |                         |                                               
218 0DAh |                         | 
218 0DAh |                         | 
218 0DAh |                         | ;-------------------------------------------------------------------------------                                        
218 0DAh |                         | ; Find the median of a 3x3 kernel.  The 9 input values are assumed to be in
218 0DAh |                         | ; z[0]..z[8] and the median value is returned in r0.  This code follows a macro
218 0DAh |                         | ; obtained from http://ndevilla.free.fr/median/median/src/optmed.c and verified
218 0DAh |                         | ; in python.
218 0DAh |                         | ;
218 0DAh |                         | ; Inputs:
218 0DAh |                         | ;
218 0DAh |                         | ;   z[0..8]     A vector of 9 values of which to find the median.
218 0DAh |                         | ;
218 0DAh |                         | ; Outputs:
218 0DAh |                         | ;
218 0DAh |                         | ;   r0          Median value
218 0DAh |                         | ; 
218 0DAh |                         | ; Registers Modified:
218 0DAh |                         | ;
218 0DAh |                         | ;   r0, r1
218 0DAh |                         | ;-------------------------------------------------------------------------------                                        
218 0DAh |                         | 
218 0DAh |                         | Find_Kernel_Median:
218 0DAh |                         | 
218 0DAh |                         |     ; Use macros to perform the sorting to avoid wasting cycles with BL/BX.
218 0DAh |                         |     ; The median value ends up in z[4], which is return in r0.
218 0DAh |                         | 
218 0DAh | 4081h 0100000010000001b |     LDR r0, z[1]
219 0DBh | 4282h 0100001010000010b |     LDR r1, z[2]
220 0DCh | 38D1h 0011100011010001b |     CMP r0, r1
221 0DDh | 9009h 1001000000001001b |     ZLS
222 0DEh | 4A81h 0100101010000001b |         STR r1, z[1]
223 0DFh | 4882h 0100100010000010b |         STR r0, z[2]
224 0E0h | 8240h 1000001001000000b |     WAK
225 0E1h | 4081h 0100000010000001b |     LDR r0, z[1]
226 0E2h | 4282h 0100001010000010b |     LDR r1, z[2]
227 0E3h | 38D1h 0011100011010001b |     CMP r0, r1
228 0E4h | 9009h 1001000000001001b |     ZLS
229 0E5h | 4A81h 0100101010000001b |         STR r1, z[1]
230 0E6h | 4882h 0100100010000010b |         STR r0, z[2]
231 0E7h | 8240h 1000001001000000b |     WAK
232 0E8h | 4084h 0100000010000100b |     LDR r0, z[4]
233 0E9h | 4285h 0100001010000101b |     LDR r1, z[5]
234 0EAh | 38D1h 0011100011010001b |     CMP r0, r1
235 0EBh | 9009h 1001000000001001b |     ZLS
236 0ECh | 4A84h 0100101010000100b |         STR r1, z[4]
237 0EDh | 4885h 0100100010000101b |         STR r0, z[5]
238 0EEh | 8240h 1000001001000000b |     WAK
239 0EFh | 4087h 0100000010000111b |     LDR r0, z[7]
240 0F0h | 4288h 0100001010001000b |     LDR r1, z[8]
241 0F1h | 38D1h 0011100011010001b |     CMP r0, r1
242 0F2h | 9009h 1001000000001001b |     ZLS
243 0F3h | 4A87h 0100101010000111b |         STR r1, z[7]
244 0F4h | 4888h 0100100010001000b |         STR r0, z[8]
245 0F5h | 8240h 1000001001000000b |     WAK
246 0F6h | 4080h 0100000010000000b |     LDR r0, z[0]
247 0F7h | 4281h 0100001010000001b |     LDR r1, z[1]
248 0F8h | 38D1h 0011100011010001b |     CMP r0, r1
249 0F9h | 9009h 1001000000001001b |     ZLS
250 0FAh | 4A80h 0100101010000000b |         STR r1, z[0]
251 0FBh | 4881h 0100100010000001b |         STR r0, z[1]
252 0FCh | 8240h 1000001001000000b |     WAK
253 0FDh | 4083h 0100000010000011b |     LDR r0, z[3]
254 0FEh | 4284h 0100001010000100b |     LDR r1, z[4]
255 0FFh | 38D1h 0011100011010001b |     CMP r0, r1
256 100h | 9009h 1001000000001001b |     ZLS
257 101h | 4A83h 0100101010000011b |         STR r1, z[3]
258 102h | 4884h 0100100010000100b |         STR r0, z[4]
259 103h | 8240h 1000001001000000b |     WAK
260 104h | 4086h 0100000010000110b |     LDR r0, z[6]
261 105h | 4287h 0100001010000111b |     LDR r1, z[7]
262 106h | 38D1h 0011100011010001b |     CMP r0, r1
263 107h | 9009h 1001000000001001b |     ZLS
264 108h | 4A86h 0100101010000110b |         STR r1, z[6]
265 109h | 4887h 0100100010000111b |         STR r0, z[7]
266 10Ah | 8240h 1000001001000000b |     WAK
267 10Bh | 4081h 0100000010000001b |     LDR r0, z[1]
268 10Ch | 4282h 0100001010000010b |     LDR r1, z[2]
269 10Dh | 38D1h 0011100011010001b |     CMP r0, r1
270 10Eh | 9009h 1001000000001001b |     ZLS
271 10Fh | 4A81h 0100101010000001b |         STR r1, z[1]
272 110h | 4882h 0100100010000010b |         STR r0, z[2]
273 111h | 8240h 1000001001000000b |     WAK
274 112h | 4084h 0100000010000100b |     LDR r0, z[4]
275 113h | 4285h 0100001010000101b |     LDR r1, z[5]
276 114h | 38D1h 0011100011010001b |     CMP r0, r1
277 115h | 9009h 1001000000001001b |     ZLS
278 116h | 4A84h 0100101010000100b |         STR r1, z[4]
279 117h | 4885h 0100100010000101b |         STR r0, z[5]
280 118h | 8240h 1000001001000000b |     WAK
281 119h | 4087h 0100000010000111b |     LDR r0, z[7]
282 11Ah | 4288h 0100001010001000b |     LDR r1, z[8]
283 11Bh | 38D1h 0011100011010001b |     CMP r0, r1
284 11Ch | 9009h 1001000000001001b |     ZLS
285 11Dh | 4A87h 0100101010000111b |         STR r1, z[7]
286 11Eh | 4888h 0100100010001000b |         STR r0, z[8]
287 11Fh | 8240h 1000001001000000b |     WAK
288 120h | 4085h 0100000010000101b |     LDR r0, z[5]
289 121h | 4288h 0100001010001000b |     LDR r1, z[8]
290 122h | 38D1h 0011100011010001b |     CMP r0, r1
291 123h | 9009h 1001000000001001b |     ZLS
292 124h | 4A85h 0100101010000101b |         STR r1, z[5]
293 125h | 4888h 0100100010001000b |         STR r0, z[8]
294 126h | 8240h 1000001001000000b |     WAK
295 127h | 4084h 0100000010000100b |     LDR r0, z[4]
296 128h | 4287h 0100001010000111b |     LDR r1, z[7]
297 129h | 38D1h 0011100011010001b |     CMP r0, r1
298 12Ah | 9009h 1001000000001001b |     ZLS
299 12Bh | 4A84h 0100101010000100b |         STR r1, z[4]
300 12Ch | 4887h 0100100010000111b |         STR r0, z[7]
301 12Dh | 8240h 1000001001000000b |     WAK
302 12Eh | 4080h 0100000010000000b |     LDR r0, z[0]
303 12Fh | 4283h 0100001010000011b |     LDR r1, z[3]
304 130h | 38D1h 0011100011010001b |     CMP r0, r1
305 131h | 9009h 1001000000001001b |     ZLS
306 132h | 4A80h 0100101010000000b |         STR r1, z[0]
307 133h | 4883h 0100100010000011b |         STR r0, z[3]
308 134h | 8240h 1000001001000000b |     WAK
309 135h | 4083h 0100000010000011b |     LDR r0, z[3]
310 136h | 4286h 0100001010000110b |     LDR r1, z[6]
311 137h | 38D1h 0011100011010001b |     CMP r0, r1
312 138h | 9009h 1001000000001001b |     ZLS
313 139h | 4A83h 0100101010000011b |         STR r1, z[3]
314 13Ah | 4886h 0100100010000110b |         STR r0, z[6]
315 13Bh | 8240h 1000001001000000b |     WAK
316 13Ch | 4082h 0100000010000010b |     LDR r0, z[2]
317 13Dh | 4285h 0100001010000101b |     LDR r1, z[5]
318 13Eh | 38D1h 0011100011010001b |     CMP r0, r1
319 13Fh | 9009h 1001000000001001b |     ZLS
320 140h | 4A82h 0100101010000010b |         STR r1, z[2]
321 141h | 4885h 0100100010000101b |         STR r0, z[5]
322 142h | 8240h 1000001001000000b |     WAK
323 143h | 4081h 0100000010000001b |     LDR r0, z[1]
324 144h | 4284h 0100001010000100b |     LDR r1, z[4]
325 145h | 38D1h 0011100011010001b |     CMP r0, r1
326 146h | 9009h 1001000000001001b |     ZLS
327 147h | 4A81h 0100101010000001b |         STR r1, z[1]
328 148h | 4884h 0100100010000100b |         STR r0, z[4]
329 149h | 8240h 1000001001000000b |     WAK
330 14Ah | 4084h 0100000010000100b |     LDR r0, z[4]
331 14Bh | 4287h 0100001010000111b |     LDR r1, z[7]
332 14Ch | 38D1h 0011100011010001b |     CMP r0, r1
333 14Dh | 9009h 1001000000001001b |     ZLS
334 14Eh | 4A84h 0100101010000100b |         STR r1, z[4]
335 14Fh | 4887h 0100100010000111b |         STR r0, z[7]
336 150h | 8240h 1000001001000000b |     WAK
337 151h | 4084h 0100000010000100b |     LDR r0, z[4]
338 152h | 4282h 0100001010000010b |     LDR r1, z[2]
339 153h | 38D1h 0011100011010001b |     CMP r0, r1
340 154h | 9009h 1001000000001001b |     ZLS
341 155h | 4A84h 0100101010000100b |         STR r1, z[4]
342 156h | 4882h 0100100010000010b |         STR r0, z[2]
343 157h | 8240h 1000001001000000b |     WAK
344 158h | 4086h 0100000010000110b |     LDR r0, z[6]
345 159h | 4284h 0100001010000100b |     LDR r1, z[4]
346 15Ah | 38D1h 0011100011010001b |     CMP r0, r1
347 15Bh | 9009h 1001000000001001b |     ZLS
348 15Ch | 4A86h 0100101010000110b |         STR r1, z[6]
349 15Dh | 4884h 0100100010000100b |         STR r0, z[4]
350 15Eh | 8240h 1000001001000000b |     WAK
351 15Fh | 4084h 0100000010000100b |     LDR r0, z[4]
352 160h | 4282h 0100001010000010b |     LDR r1, z[2]
353 161h | 38D1h 0011100011010001b |     CMP r0, r1
354 162h | 9009h 1001000000001001b |     ZLS
355 163h | 4A84h 0100101010000100b |         STR r1, z[4]
356 164h | 4882h 0100100010000010b |         STR r0, z[2]
357 165h | 8240h 1000001001000000b |     WAK
358 166h | 4084h 0100000010000100b |     LDR     r0, z[4]
359 167h | 8210h 1000001000010000b |     BX
360 168h |                         | 
360 168h |                         | 
360 168h |                         | 
360 168h |                         | ;-------------------------------------------------------------------------------
360 168h |                         | ; Output_Data_Block
360 168h |                         | ;
360 168h |                         | ; Description:
360 168h |                         | ;
360 168h |                         | ;   The output function, which dumps 64 bytes of data out through the column
360 168h |                         | ;   data bus.  This can be called with different starting addresses to determine
360 168h |                         | ;   whether X, Y, Z or some other block is output.
360 168h |                         | ;
360 168h |                         | ; Inputs:
360 168h |                         | ;
360 168h |                         | ;   r0          The address to begin outputing.  The last byte will be output
360 168h |                         | ;               from address r0+63.
360 168h |                         | ;
360 168h |                         | ; Outputs:
360 168h |                         | ;
360 168h |                         | ;   -           64 bytes for each NP on column data bus.
360 168h |                         | ;
360 168h |                         | ; Registers Modified:
360 168h |                         | ;
360 168h |                         | ;   r0, r1
360 168h |                         | ;-------------------------------------------------------------------------------
360 168h |                         | 
360 168h |                         | Output_Data_Block:
360 168h |                         | 
360 168h | 42D0h 0100001011010000b |     LDR     r1, r0          ; Calculate the final address.
361 169h | 0340h 0000001101000000b |     ADD     r1, 64      
362 16Ah |                         | 
362 16Ah |                         | OUTPUT_DATA_BLOCK_LOOP:
362 16Ah |                         | 
362 16Ah | A0F0h 1010000011110000b |     OUT     [r0], 0          ; Row 0
363 16Bh | A2F0h 1010001011110000b |     OUT     [r0], 1          ; Row 1
364 16Ch | A4F0h 1010010011110000b |     OUT     [r0], 2          ; Row 2
365 16Dh | A6F0h 1010011011110000b |     OUT     [r0], 3          ; Row 3
366 16Eh | A8F0h 1010100011110000b |     OUT     [r0], 4          ; Row 4
367 16Fh | AAF0h 1010101011110000b |     OUT     [r0], 5          ; Row 5
368 170h | ACF0h 1010110011110000b |     OUT     [r0], 6          ; Row 6
369 171h | AEF0h 1010111011110000b |     OUT     [r0], 7          ; Row 7
370 172h |                         |     
370 172h | 0101h 0000000100000001b |     ADD     r0, 1
371 173h | 38D1h 0011100011010001b |     CMP     r0, r1
372 174h | D6A1h 1101011010100001b |     BNE     OUTPUT_DATA_BLOCK_LOOP
373 175h | 8210h 1000001000010000b |     BX 
